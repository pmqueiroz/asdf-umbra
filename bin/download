#!/usr/bin/env bash

set -eu
[ "${BASH_VERSINFO[0]}" -ge 3 ] && set -o pipefail

current_script_path=${BASH_SOURCE[0]}
plugin_dir=$(dirname "$(dirname "$current_script_path")")

# shellcheck source=./lib/utils.bash
source "${plugin_dir}/lib/utils.bash"

download_umbra() {
  local version=$1
  local platform=""
  local arch=""

  platform=$(get_platform)
  arch=$(get_arch)
  download_file="$ASDF_DOWNLOAD_PATH/$TOOL_NAME-$ASDF_INSTALL_VERSION.tar.gz"
  download_file_sha="${download_file}.sha256"

  download_release "$version" "$platform" "$arch" "$download_file"

  if [ "unset" = "${ASDF_GOLANG_SKIP_CHECKSUM:-unset}" ]; then
    download_sha "$version" "$platform" "$arch" "$download_file_sha"

    echo 'verifying checksum'
    if ! check_shasum "${download_file}" "${download_file_sha}"; then
      fail "Authenticity of package can not be assured. Exiting."
    else
      msg "checksum verified"
    fi
  else
    err "checksum skipped"
  fi

  tar -xzf "$download_file" -C "$ASDF_DOWNLOAD_PATH" --strip-components=1 || fail "Could not extract $download_file"

  rm "$download_file"
}

download_umbra "$ASDF_INSTALL_VERSION"
